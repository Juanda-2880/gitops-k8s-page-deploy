name: "Run SAST, Build Docker, Scan & Update Manifest"

on:
  push:
    branches:
      - main

jobs:

  sonarqube_sast_scan:
    name: SonarQube Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        with:
          projectBaseDir: Page 
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}


  build_push_docker:
    name: Build & Push Docker Image
    needs: sonarqube_sast_scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./Page
          file: ./Page/Dockerfile
          push: true
          tags: |
            juandau2880/overwatchfanpage:latest
            juandau2880/overwatchfanpage:v${{ github.run_number }}


  docker_image_scan:
    name: Trivy Vulnerability Scan
    needs: build_push_docker
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'juandau2880/overwatchfanpage:v${{ github.run_number }}'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'


  update_k8s_manifest:
    name: Update K8s Deployment Manifest
    needs: docker_image_scan
    runs-on: ubuntu-latest
    permissions:
      contents: write  
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git User
        run: |
          git config --global user.email "${{ secrets.GIT_EMAIL }}"
          git config --global user.name "${{ secrets.GIT_USERNAME }}"
      
      - name: Update Image Tag in Deployment
        run: |
          git pull
          # Actualiza el archivo deployment.yaml dentro de la carpeta ArgoCD
          sed -i "s|image: juandau2880/overwatchfanpage:.*$|image: juandau2880/overwatchfanpage:v${{ github.run_number }}|" ArgoCD/manifests/deployment.yaml
          
          # Verificaci√≥n (Opcional, para ver en logs)
          cat ArgoCD/manifests/deployment.yaml | grep "image:"
          
          # Commit y Push
          git add ArgoCD/manifests/deployment.yaml
          git commit -m "GitOps Auto-Update: Deploying version v${{ github.run_number }}"
          git push